# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  watch:
    types: [started]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a single command using the runners shell
      - name: æ‰§è¡Œä¾èµ–
        run: |
          sudo apt  install \
          make binutils autoconf automake autotools-dev \
          libtool pkg-config git curl dpkg-dev autopoint libcppunit-dev \
          libxml2-dev  lzip wget jq -y
      - name: å‡†å¤‡
        run: |
          git clone https://github.com/aria2/aria2.git
          cd aria2
          #echo "::set-env name=ARIAPATH::$(pwd)"
          autoreconf -i
          git clone https://github.com/Rorschach331/aria2c-aarch64-build.git ./custom-shells
          cd ./custom-shells
          ls
          sudo chmod +x *.sh
          sudo ./tools.sh
          sudo ./libs.sh
          #cd /tmp/build-aria2c/aria2
          #cd {{ env.aria2_path }}
      - name: ç¼–è¯‘
        id: makefile
        run: |
          cd aria2
          ls /opt/aria2-aarch64/build_libs/lib/
          ./custom-shells/make-config.sh
          make
          /opt/aria2-aarch64/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin/aarch64-linux-gnu-strip ./src/aria2c
          echo "status=success" >> $GITHUB_OUTPUT
      - name: æ‰“åŒ…
        uses: actions/upload-artifact@v4
        if: steps.makefile.outputs.status == 'success' && !cancelled()
        with:
          name: aria2c-aarch64-linux-builds
          path: aria2/src/aria2c

      - name: Generate release tag
        id: tag
        if: cancelled() != true
        run: |
          ARIA2VERSION=$(curl -sL https://api.github.com/repos/aria2/aria2/releases | jq -r ".[0].tag_name")
          MYVERSION=$(curl -sL https://api.github.com/repos/Rorschach331/aria2c-aarch64-build/releases | jq -r ".[0].tag_name")
          echo "release_tag=$ARIA2VERSION" >> $GITHUB_OUTPUT
          if [ "$ARIA2VERSION" != "$MYVERSION" ]
          then
            echo "ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¯ä»¥å‘å¸ƒ"
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Upload binary to release
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Aria2c ${{ steps.tag.outputs.release_tag }} (Aarch64 Static)
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: aria2/src/aria2c
          body: |
            ## âœ¨ Release Notes

            ### ðŸ›  Major Fixes & Improvements
            - **OpenSSL 3.x Support**: Resolved "Legacy Provider" loading failures and static linking issues.
            - **Extreme Optimization**: Enabled `-Os` (size), `-flto` (Link Time Optimization), and `--gc-sections` for minimal binary size.
            - **Build Stability**: Completely rewrote `libs.sh` with error checking (`set -e`) and reliable GitHub Release sources.
            - **Compiler Fixes**: Switched to `gcc-ar`/`gcc-ranlib` to correctly handle LTO plugin objects.
            - **Dependency Upgrades**:
              - Zlib -> 1.3.1
              - OpenSSL -> 3.4.0
              - Libssh2 -> 1.11.1

            > This project's build scripts and configuration were analyzed, fixed, and optimized using **Antigravity AI**.

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        if: cancelled() != true
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
